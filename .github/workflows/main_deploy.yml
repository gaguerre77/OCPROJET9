name: Deploy and Validate Metadata

on:
  push:
    branches:
      - main

jobs:
  sfdxvalidate:
    name: "Run SFDX Validate and Generate Report"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node and SFDX
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"

      - name: ğŸ”§ Install Salesforce CLI and Delta Plugin
        run: |
          npm install -g @salesforce/cli
          npm install -g sfdx-git-delta@3.3.0

      - name: ğŸ” Auth Salesforce Org via SFDX URL
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth_url.txt
          sf org login sfdx-url --sfdx-url-file auth_url.txt --alias deployOrg --set-default

      - name: ğŸ“ Generate delta and package.xml
        run: |
          mkdir -p .temp
          sfdx sgd:source:delta --to HEAD --from HEAD~1 --output .temp --generate-delta

      - name: ğŸš€ Deploy metadata in CheckOnly mode
        run: |
          sfdx force:source:deploy -x .temp/package/package.xml -u deployOrg --checkonly --testlevel RunLocalTests --json > deploy-result.json

      - name: ğŸ“ Generate Deployment Report
        run: |
          echo "## ğŸš€ Rapport de DÃ©ploiement - $(date)" >> deploy-report.md
          echo "### ğŸ‘¤ Auteur : ${{ github.actor }}" >> deploy-report.md
          echo "### ğŸ” Branche : ${{ github.ref }}" >> deploy-report.md
          echo "### ğŸ§ª Mode : Validation (checkonly)" >> deploy-report.md
          echo "---" >> deploy-report.md
          echo "### ğŸ“ Delta gÃ©nÃ©rÃ© :" >> deploy-report.md
          cat .temp/package/package.xml >> deploy-report.md
          echo "---" >> deploy-report.md
          echo "### RÃ©sultat JSON :" >> deploy-report.md
          cat deploy-result.json >> deploy-report.md

      - name: ğŸ’¾ Commit report to repo (optional)
        if: success()
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b deploy-report-$(date +%s)
          git add deploy-report.md
          git commit -m "ğŸ“ Add deploy report"
          git push origin HEAD

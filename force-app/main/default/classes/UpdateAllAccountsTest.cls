@isTest
public class UpdateAllAccountsTest {
  @isTest
  static void testBatchUpdatesPricesAndCalculatesCA() {
    // ğŸ§ª CrÃ©er les donnÃ©es de base via la factory
    TestDataFactory.TestEntities data = TestDataFactory.createBaseDataWithDraftOrders(
      2
    );

    // ğŸ›’ Ajouter des OrderItems
    List<OrderItem> items = new List<OrderItem>();
    for (Order o : data.orders) {
      items.add(
        new OrderItem(
          OrderId = o.Id,
          Quantity = 2,
          PricebookEntryId = data.pricebookEntryId,
          UnitPrice = 80 // volontairement diffÃ©rent du prix standard (100)
        )
      );
    }
    insert items;

    // âœ… Activer une commande pour test du CA
    Order activatedOrder = data.orders[0];
    activatedOrder.Status = 'Activated';
    update activatedOrder;

    // âš™ï¸ Lancer le batch
    Test.startTest();
    UpdateAllAccounts batch = new UpdateAllAccounts();
    Database.executeBatch(batch, 50);
    Test.stopTest();

    // âœ… VÃ©rification : CA du compte (commande activÃ©e = 2 x 100)
    Account acc = [
      SELECT Id, Chiffre_d_affaire__c
      FROM Account
      WHERE Id = :data.accountId
    ];
    System.assertEquals(
      200,
      acc.Chiffre_d_affaire__c,
      'ğŸ’¥ Le CA du compte est incorrect'
    );

    // ğŸ§ª VÃ©rification que les prix des OrderItems ont Ã©tÃ© mis Ã  jour Ã  100
    for (OrderItem oi : [
      SELECT Id, UnitPrice
      FROM OrderItem
      WHERE OrderId IN :data.orders
    ]) {
      System.assertEquals(
        100,
        oi.UnitPrice,
        'ğŸ’¥ Prix de l\'OrderItem non mis Ã  jour'
      );
    }
  }

  @isTest
  static void testBatchCumulatesCAForSameAccount() {
    // ğŸ§ª CrÃ©er 2 commandes pour le mÃªme compte
    TestDataFactory.TestEntities data = TestDataFactory.createBaseDataWithDraftOrders(
      2
    );

    // Ajouter des OrderItems Ã  chaque commande
    List<OrderItem> items = new List<OrderItem>();
    for (Order o : data.orders) {
      items.add(
        new OrderItem(
          OrderId = o.Id,
          Quantity = 2,
          PricebookEntryId = data.pricebookEntryId,
          UnitPrice = 80
        )
      );
    }
    insert items;

    // âœ… Activer les 2 commandes
    for (Order o : data.orders) {
      o.Status = 'Activated';
    }
    update data.orders;

    // ğŸ”„ Lancer le batch
    Test.startTest();
    UpdateAllAccounts batch = new UpdateAllAccounts();
    Database.executeBatch(batch, 50);
    Test.stopTest();

    // âœ… VÃ©rification : 2 commandes * 2 * 100 = 400
    Account acc = [
      SELECT Id, Chiffre_d_affaire__c
      FROM Account
      WHERE Id = :data.accountId
    ];
    System.assertEquals(
      400,
      acc.Chiffre_d_affaire__c,
      'ğŸ’¥ Le CA cumulÃ© sur plusieurs commandes activÃ©es est incorrect'
    );
  }
}
